■ ファイル一覧、検索

S3 検索
aws s3 ls [S3パス] --recursive --human-readable | grep -iE 'SearchWord' > result.txt

-i 大文字小文字区別しない
-E 正規表現

S3 リスト作成
aws s3 ls [S3パス] --recursive --human-readable --summarize > result.txt

--summarize  全体サマリ表示


EC2 検索
find ./home/user1 -type f -iregex ".*SearchWord.*" | xargs ls -l --time-style=+%Y-%m-%d\ %H:%M:%S > result.txt

-iregex  正規表現 大文字小文字区別しない
-regex   正規表現 大文字小文字区別あり

xargs 実行



■ S3から復旧 （OracleでCSV出力した場合）

COPY schema.TARGET_TABLE
FROM 's3://Ｓ３パス/TARGET_TABLE.csv.gz' CREDENTIALS 'aws_access_key_id=XXX;aws_secret_access_key=XXX' CSV GZIP DELIMITER ',' IGNOREHEADER 1 DATEFORMAT 'auto' TIMEFORMAT 'auto';

  注意点
    デリミタ          DELIMITER '\t'   DELIMITER ','
    ヘッダ行あり      IGNOREHEADER 1
    日付フォーマット  DATEFORMAT 'auto' TIMEFORMAT 'auto'
    改行コード        \n
    ファイル名        大文字、小文字を区別する



■ S3から復旧 （OracleでCSV出力した場合）

COPY schema.TARGET_TABLE
FROM 's3://Ｓ３パス/TARGET_TABLE.csv.gz' CREDENTIALS 'aws_access_key_id=XXX;aws_secret_access_key=XXX' CSV GZIP DELIMITER ',' IGNOREHEADER 1 DATEFORMAT 'auto' TIMEFORMAT 'auto';

  注意点
    デリミタ          DELIMITER '\t'   DELIMITER ','
    ヘッダ行あり      IGNOREHEADER 1
    日付フォーマット  DATEFORMAT 'auto' TIMEFORMAT 'auto'
    改行コード        \n
    ファイル名        大文字、小文字を区別する




■ S3へ退避、S3から復旧 （一般）

  ADDQUOTES             ダブルクォーテーションをつける  → 読み込む際は、REMOVEQUOTES  が必要
  ALLOWOVERWRITE        S3ファイル上書きする
  DELIMITER ','         デリミタ
  PARALLEL OFF          通常(省略)時はON。 OFFの場合、6.2GBまで1つのファイルに出力する。時間がかかる

  ※ヘッダは出力されない!!!

○デリミタ = タブの場合
UNLOAD($$ SELECT * FROM schema.TARGET_TABLE $$)
TO 's3://Ｓ３パス/TARGET_TABLE' CREDENTIALS 'aws_access_key_id=XXX;aws_secret_access_key=XXX' DELIMITER '\t' GZIP ALLOWOVERWRITE;
  ↓
COPY schema.TARGET_TABLE FROM 's3://Ｓ３パス/TARGET_TABLE' CREDENTIALS 'aws_access_key_id=XXX;aws_secret_access_key=XXX' GZIP DELIMITER '\t' DATEFORMAT 'auto';"


○デリミタ = カンマ、ダブルクォーテーションの場合
UNLOAD($$ SELECT * FROM schema.TARGET_TABLE $$)
TO 's3://Ｓ３パス/TARGET_TABLE' CREDENTIALS 'aws_access_key_id=XXX;aws_secret_access_key=XXX' DELIMITER ',' GZIP ADDQUOTES ALLOWOVERWRITE;
  ↓
COPY schema.TARGET_TABLE FROM 's3://Ｓ３パス/TARGET_TABLE' CREDENTIALS 'aws_access_key_id=XXX;aws_secret_access_key=XXX' GZIP DELIMITER ',' REMOVEQUOTES DATEFORMAT 'auto';"




■ S3 <-> EC2 コピー

S3パスの全ファイルをEC2にコピー
aws s3 cp [S3パス]/ . --recursive

特定ファイルをEC2にコピー
aws s3 cp [S3パス]/特定ファイル .

EC2のファイルをS3にコピー
aws s3 cp testfile [S3パス]


ローカルからS3にコピー
aws s3 cp <LocalPath> <S3Path>

S3からローカルにコピー
aws s3 cp <S3Path> <LocalPath>

S3からS3にコピー
aws s3 cp <S3Path> <S3Path>


■ SQL実行

psql -h ホスト名 -U ユーザ名 -d DB名 -p ポート -f ./test.sql >& test.log&

psql -h XXXX.amazonaws.com -U user1 -d db1 -p 1234 -f ./test.sql >& test.log&









